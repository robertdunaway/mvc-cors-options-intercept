mashupApp.service("coreDataService",["$http","$q","$log","cacheService",function(e,t,r,a){"use strict";return{getCache:function(e){var r=t.defer();return a.getCache(e).then(function(e){r.resolve(e)}),r.promise}}}]),mashupApp.factory("alertService",["$rootScope",function(e){"use strict";var t={};return e.alerts=[],t.add=function(r,a){e.alerts.push({type:r,msg:a,close:function(){t.closeAlert(this)}})},t.closeAlert=function(r){t.closeAlertIdx(e.alerts.indexOf(r))},t.closeAlertIdx=function(t){e.alerts.splice(t,1)},t}]),mashupApp.factory("Base64",function(){"use strict";var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(t){var r,a,n,o,i,c="",s="",u="",l=0;do r=t.charCodeAt(l++),a=t.charCodeAt(l++),s=t.charCodeAt(l++),n=r>>2,o=(3&r)<<4|a>>4,i=(15&a)<<2|s>>6,u=63&s,isNaN(a)?i=u=64:isNaN(s)&&(u=64),c=c+e.charAt(n)+e.charAt(o)+e.charAt(i)+e.charAt(u),r=a=s="",n=o=i=u="";while(l<t.length);return c},decode:function(t){var r,a,n,o,i,c="",s="",u="",l=0,d=/[^A-Za-z0-9\+\/\=]/g;d.exec(t)&&alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\\nExpect errors in decoding."),t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");do n=e.indexOf(t.charAt(l++)),o=e.indexOf(t.charAt(l++)),i=e.indexOf(t.charAt(l++)),u=e.indexOf(t.charAt(l++)),r=n<<2|o>>4,a=(15&o)<<4|i>>2,s=(3&i)<<6|u,c+=String.fromCharCode(r),64!==i&&(c+=String.fromCharCode(a)),64!==u&&(c+=String.fromCharCode(s)),r=a=s="",n=o=i=u="";while(l<t.length);return c}}}),mashupApp.service("cacheService",["$http","$q","$log","utility","detectService","sessionService",function(e,t,r,a,n,o){"use strict";var i=new ydn.db.Storage("mashCacheDB"),c=!1;i.onReady(function(){c=!0,console.log("mashCacheDB is ready.  [cacheService]")});var s=function(e,r){var a=t.defer(),n=!0,s=60*r*1e3,u=o.envSession();u.batteryLevel&&u.batteryLevel<=30&&(s=4*s);var l=(new Date).getTime();return function d(){if(c)try{i.executeSql("SELECT * FROM mashCacheAge WHERE id = '"+e+"'").then(function(e){var t=e.length;if(t>0){var r=l-e[0].updatedDate;n=r>s?!0:!1,a.resolve(n)}else a.resolve(!0)})}catch(t){a.resolve(!0)}else setTimeout(d,500)}(),a.promise},u=function(e){var t={id:e,updatedDate:(new Date).getTime()};i.put({name:"mashCacheAge",keyPath:"id"},t)},l=function(e){var r=t.defer();return function a(){if(c)try{i.executeSql("SELECT * FROM '"+e+"'").then(function(e){r.resolve("N"===e?"":e)})}catch(t){r.resolve("NoCache")}else setTimeout(a,500)}(),r.promise},d=10080;return s("mashCacheStart",d).then(function(e){if(e){try{i.clear()}catch(t){}var n=a.getLogObject("mashCasheDelete","Mashup.UI.Core","cacheService","root of cacheService","Stale-Cache",o);r.log("mashCacheDB was stale so deleted.",n),u("mashCacheStart")}}),{dbCache:i,putCache:function(e,t,r){i.put(t,r),u(e)},getCache:function(e){var r=t.defer();return l(e).then(function(e){r.resolve(e)},function(e){r.reject()}),r.promise},getData:function(c,d,g,f,h){var v=t.defer(),p=g.url;return s(c,f).then(function(t){h.heartBeatName=h.heartBeatName?h.heartBeatName||h.heartBeatUrl:h.heartBeatName||p;var s=n.detect(h.heartBeatUrl,h.heartBeatName);t&&s?e(g).success(function(e){try{i.put(d,e),u(c)}catch(t){var n=a.getLogObject("mashCasheDelete","Mashup.UI.Core","cacheService","getData","Error",o);r.error(t,n),indexedDB.deleteDatabase("mashCacheDB"),r.log("IndexedDB error on updating a cache. Deleted database",n)}v.resolve(e)}).error(function(){n.failed(h.heartBeatUrl,h.heartBeatName),l(c).then(function(e){v.resolve(e)})}):l(c).then(function(e){v.resolve(e)})}),v.promise}}}]),mashupApp.service("detectService",["$http","$q","$log","$interval","$filter","$rootScope","utility","sessionService",function(e,t,r,a,n,o,i,c){"use strict";!function(){var e=new ydn.db.Storage("logServiceDB"),t=!1;e.onReady(function(){t=!0,console.log("logServiceDB is ready. [detectService]")});var a=1008e4,n=6048e5;setInterval(function(){!function a(){if(t){var o=(new Date).getTime()-n,s=ydn.db.KeyRange.upperBound(o,!0),u=i.getLogObject("detectManagement:Truncate","Mashup.UI.Core","detectService","anonymous:setInterval",null,c);e.remove("heartbeat",s).done(function(e){u.status=!0,u.count=e,r.log("Truncating old [heartbeat] records.",u)}).fail(function(e){throw u.status=!1,r.log("Truncating old [heartbeat] records. (failed)",u),e})}else setTimeout(a,500)}()},a,0,!1)}(),o.heartBeatMonitorList=[];var s=c.envSession(),u=3e5;s.batteryLevel&&s.batteryLevel<=30&&(u=2*u),a(function(){_.each(o.heartBeatMonitorList,function(t){var r=!0;e.get(t.url,{withCredentials:!0}).success(function(e){r=!0,t.detected=r,l(t.id,r,e)}).error(function(){r=!1,t.detected=r,l(t.id,r),d(t)})})},u,0,!1);var l=function(e,t,a){var o=n("date")((new Date).getTime(),"short"),s="The heartbeat result for '"+e+"' is: [ "+t+" ] at "+o,u=i.getLogObject("HeartBeat","Mashup.UI.Core","detectService","recordHeartBeatResult",t,c);t?(u.msg=s,console.info(angular.fromJson(u))):(u.subject="HeartBeatFail",r.error("HeartBeatFail: "+s,u))},d=function(e){if(!_.where(o.codeBlueList,{id:e.id}).length&&(o.codeBlueList.push(e),!g)){var t=i.getLogObject("StartCodeBlueMonitor","Mashup.UI.Core","detectService","addToCodeBlueList","Starting",c);r.info("Starting up code Blue monitor from heartbeat monitor.",t),f()}};o.codeBlueList=[];var g,f=function(){var t=6e4;s.batteryLevel&&s.batteryLevel<=30&&(t=3*t),g=a(function(){var t=n("date")((new Date).getTime(),"short");if(0===o.codeBlueList.length){a.cancel(g),g=!1;var s=i.getLogObject("CodeBlueMonitor","Mashup.UI.Core","detectService","startCodeBlueMonitor","ended",c);r.info("codeBlueMonitor ended "+t,s)}else _.each(o.codeBlueList,function(t){var r=!0;e.get(t.url,{withCredentials:!0}).success(function(e){r=!0,t.detected=r,h(t.id,r,e),o.codeBlueList=_.filter(o.codeBlueList,function(e){return e.id!==t.id})}).error(function(){r=!1,t.detected=r,h(t.id,r)})})},t,0,!1)},h=function(e,t,a){var o=n("date")((new Date).getTime(),"short"),s="The code Blue result for "+e+" is: [ "+t+" ] at "+o,u=i.getLogObject("CodeBlueMonitor","Mashup.UI.Core","detectService","recordCodeBlueResult",t,c);u.webApiName=e,t?r.info(s,u):r.error(s,u)},v=function(e,t){if(!e)return!0;try{var a=_.where(o.heartBeatMonitorList,{id:t});if(0===a.length){var n={id:t,url:e,detected:!0};return o.heartBeatMonitorList.push(n),!0}return a[0].detected}catch(s){var u=i.getLogObject("CodeBlueMonitor","Mashup.UI.Core","detectService","canDetectHeartBeat","Error",c);u.webApiName=t,u.heartBeatUrl=e,u.error=s,r.error("detectService.canDetectHeartBeat: "+s,u)}return!0};return{detect:function(e,t){return v(e,t)},failed:function(e,t){var a=i.getLogObject("CodeBlueMonitor","Mashup.UI.Core","detectService","detectService.failed",!1,c);if(a.webApiName=t,a.heartBeatUrl=e,r.warn("detectService.failed: A call to Web Api: "+t+" failed",a),!_.where(o.codeBlueList,{id:t}).length){var n={id:t,url:e,detected:!1};o.codeBlueList.push(n)}g||f()}}}]),mashupApp.config(["$provide",function(e){e.decorator("$log",["$delegate","logService",function(e,t){return t(e)}])}]),mashupApp.factory("logService",["$filter","sessionService","utility",function(e,t,r){"use strict";return function(a){var n=1,o=0,i={stores:[{name:"log",keyPath:"logId",autoIncrement:!1},{name:"heartbeat",keyPath:"logId",autoIncrement:!1}]},c=new ydn.db.Storage("logServiceDB",i),s=!1;c.onReady(function(){s=!0,console.log("logServiceDB is ready. [logService]")}),c.addEventListener("error",function(e){var t=e.getError();console.log("connection failed with "+t.name)});var u=function(t,a){var i=(new Date).getTime(),c=r.localMilToUtcMil(i),s=e("date")(i,"short"),u=e("date")(c,"short"),l={msg:t[o],logId:c,dateTimeLocal:s,dateTimeUtc:u,logType:a,transmitted:!1};if(t.length>1)for(var d in t[n])t[n].hasOwnProperty(d)&&(l[d]=t[n][d]);return l},l=function(e,t){!function r(){if(s){if(angular.isString(e[o])){var a=u(e,t),n=a.subject;switch(n){case"Perf":break;case"HeartBeatFail":case"CodeBlueMonitor":c.put({name:"heartbeat"},a);break;case"Debug":break;case"Error":}c.put({name:"log"},a)}}else setTimeout(r,500)}()};return function(){var e=null,a=null,n=t.envSession();"desktop"===n.deviceType?(e=72e5,a=6048e5):(e=18e5,a=1728e5),n.batteryLevel&&n.batteryLevel<=30&&(e=4*e,a=4*a),setInterval(function(){!function e(){if(s){var n=r.localMilToUtcMil((new Date).getTime())-a,o=ydn.db.KeyRange.upperBound(n,!0),i=r.getLogObject("logManagement:Truncate","Mashup.UI.Core","logService","anonymous:setInterval",null,t);c.remove("log",o).done(function(e){i.status=!0,i.count=e,l(["Truncating old [log] records.",i],"log"),console.log(["Truncating old [log] records.",i])}).fail(function(e){throw i.status=!1,l(["Truncating old [log] records. (failed)",i],"log"),console.log(["Truncating old [log] records.",i]),e})}else setTimeout(e,500)}()},e,0,!1)}(),{log:function(){a.log(arguments[o]);try{l(arguments,"log")}catch(e){}},info:function(){a.info(arguments[o]);try{l(arguments,"info")}catch(e){}},error:function(){a.error(arguments[o]);try{l(arguments,"error")}catch(e){}},warn:function(){a.warn(arguments[o]);try{l(arguments,"warn")}catch(e){}}}}}]),mashupApp.service("sessionService",function(){"use strict";var e={};!function(){var t="Unknown OS";-1!==navigator.appVersion.indexOf("Win")&&(t="Windows"),-1!==navigator.appVersion.indexOf("Mac")&&(t="MacOS"),-1!==navigator.appVersion.indexOf("X11")&&(t="UNIX"),-1!==navigator.appVersion.indexOf("Linux")&&(t="Linux"),e.osName=t,e.appVersion=navigator.appVersion}(),function(){var t,r,a,n=navigator.userAgent,o=navigator.appName,i=""+parseFloat(navigator.appVersion),c=parseInt(navigator.appVersion,10);-1!==(r=n.indexOf("Opera"))?(o="Opera",i=n.substring(r+6),-1!==(r=n.indexOf("Version"))&&(i=n.substring(r+8))):-1!==(r=n.indexOf("MSIE"))?(o="Microsoft Internet Explorer",i=n.substring(r+5)):-1!==(r=n.indexOf("Chrome"))?(o="Chrome",i=n.substring(r+7)):-1!==(r=n.indexOf("Safari"))?(o="Safari",i=n.substring(r+7),-1!==(r=n.indexOf("Version"))&&(i=n.substring(r+8))):-1!==(r=n.indexOf("Firefox"))?(o="Firefox",i=n.substring(r+8)):(t=n.lastIndexOf(" ")+1)<(r=n.lastIndexOf("/"))&&(o=n.substring(t,r),i=n.substring(r+1),o.toLowerCase()===o.toUpperCase()&&(o=navigator.appName)),-1!==(a=i.indexOf(";"))&&(i=i.substring(0,a)),-1!==(a=i.indexOf(" "))&&(i=i.substring(0,a)),c=parseInt(""+i,10),isNaN(c)&&(i=""+parseFloat(navigator.appVersion),c=parseInt(navigator.appVersion,10)),e.browserName=o,e.fullVersion=i,e.majorVersion=c}(),function(){var t={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return t.Android()||t.BlackBerry()||t.iOS()||t.Opera()||t.Windows()}},r="";t.any()?(e.deviceType="mobile",t.Android()&&(r="Android"),t.BlackBerry()&&(r="BlackBerry"),t.iOS()&&(r="iPhone|iPad|iPod"),t.Opera()&&(r="Opera Mini"),t.Windows()&&(r="IEMobile")):e.deviceType="desktop",e.mobileType=r}(),function(){var t=navigator.battery||navigator.webkitBattery||navigator.mozBattery;if(t){var r=function(){e.batteryLevel=100*t.level};t.addEventListener("levelchange",function(e){console.warn("sessionService: Battery level change: ",t.level),r()},!1)}}();var t={};return{getUserSessions:function(){return t.hasOwnProperty("logUserName")||(t.logUserName="unknown-user"),t.hasOwnProperty("logAppName")||(t.logAppName="unknown-app"),t},setUserSession:function(e){return t=e,!0},envSession:function(){return e}}}),mashupApp.service("utility",["utility_UtcDateService","utility_LogHelper",function(e,t){"use strict";var r=e.utcMilToLocalMil,a=e.localMilToUtcMil,n=e.localDateToUtcDate,o=e.utcDateToLocalDate,i=t.getLogObject;return{localDateToUtcDate:n,utcDateToLocalDate:o,localMilToUtcMil:a,utcMilToLocalMil:r,getLogObject:i}}]),mashupApp.service("utility_LogHelper",function(){"use strict";var e=function(e,t,r,a,n,o){var i={subject:e,app:t,module:r,func:a,status:n};try{var c=o.getUserSessions();i.logUserName=c.hasOwnProperty("logUserName")?c.logUserName:"unknown-user-property",i.logAppName=c.hasOwnProperty("logAppName")?c.logAppName:"unknown-app-property"}catch(s){}try{var u=o.envSession();i.osName=u.osName,i.browser=u.browserName+" "+u.fullVersion,i.deviceType="desktop"===u.deviceType?u.deviceType:u.deviceType+": "+u.mobileType}catch(s){}return i};return{getLogObject:e}}),mashupApp.service("utility_UtcDateService",function(){"use strict";var e=function(e){var t=new Date;return(new Date).setTime(e-6e4*t.getTimezoneOffset())},t=function(e){var t=new Date;return(new Date).setTime(e+6e4*t.getTimezoneOffset())},r=function(e){return new Date(t(e.getTime()))},a=function(t){return new Date(e(t.getTime()))};return{localDateToUtcDate:r,utcDateToLocalDate:a,localMilToUtcMil:t,utcMilToLocalMil:e}});
//# sourceMappingURL=core.services.min.js.map